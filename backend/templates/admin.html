<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Portfolio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/admin.css') }}">
</head>

<body>

  <div class="sidebar">
    <div class="logo"><i class="fas fa-rocket"></i> Admin Panel</div>
    <div class="nav-item active" onclick="switchView('projects')"><i class="fas fa-project-diagram"></i> Projects</div>
    <div class="nav-item" onclick="switchView('resume')"><i class="fas fa-file-alt"></i> Resume</div>
    <div class="nav-item" onclick="switchView('skills')"><i class="fas fa-code"></i> Skills</div>
    <div class="nav-item" onclick="switchView('profile')"><i class="fas fa-user"></i> Profile</div>
    <div style="margin-top: auto;">
      <a href="/admin/backup" class="nav-item" style="color: var(--success); text-decoration: none;" download>
        <i class="fas fa-download"></i> Backup Database
      </a>
      <a href="/" target="_blank" class="nav-item"><i class="fas fa-external-link-alt"></i> View Site</a>
    </div>
  </div>

  <div class="main-content">
    <!-- Projects View -->
    <div id="view-projects" class="view-section">
      <div class="header">
        <h2>Projects</h2>
        <button class="btn btn-primary" onclick="openModal('project')"><i class="fas fa-plus"></i> Add Project</button>
      </div>
      <div class="item-list">
        {% for category, items in projects|groupby('category') %}
        <details class="category-group">
          <summary
            style="margin: 1.5rem 0 0.5rem; color: var(--accent); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; outline: none; user-select: none;">
            {{ category or 'Uncategorized' }} <span style="font-size: 0.8em; opacity: 0.7; margin-left: 0.5rem;">({{
              items|length }})</span>
          </summary>
          <div class="list-group">
            {% for p in items %}
            {% set trans = p.translations | selectattr('lang', 'equalto', 'es') | first %}
            <div class="list-item" onclick='editProject({{ p.id }})'
              style="cursor: pointer; transition: transform 0.2s, border-color 0.2s;">
              <div class="item-info">
                <h3>{{ trans.title if trans else p.slug }}</h3>
                <p>{{ p.category or '' }}</p>
              </div>
              <div class="item-actions">
                <button class="action-btn delete"
                  onclick="event.stopPropagation(); deleteItem('project', {{ p.id }})"><i
                    class="fas fa-trash"></i></button>
              </div>
            </div>
            {% endfor %}
          </div>
        </details>
        {% endfor %}
      </div>
    </div>

    <!-- Resume View (Experience, Education, Certifications) -->
    <div id="view-resume" class="view-section hidden">
      <div class="header">
        <h2>Resume</h2>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="switchResumeTab(this, 'resume-experience')">Experience</div>
        <div class="tab" onclick="switchResumeTab(this, 'resume-education')">Education</div>
        <div class="tab" onclick="switchResumeTab(this, 'resume-certifications')">Certifications</div>
      </div>

      <!-- Experience Sub-View -->
      <div id="resume-experience" class="resume-tab-content">
        <div class="header" style="margin-bottom: 1rem;">
          <h3>Experience History</h3>
          <button class="btn btn-primary" onclick="openModal('experience')"><i class="fas fa-plus"></i> Add</button>
        </div>
        <div class="item-list">
          {% for e in experiences %}
          {% set trans = e.translations | selectattr('lang', 'equalto', 'es') | first %}
          <div class="list-item" onclick='editExperience({{ e.id }})' style="cursor: pointer;">
            <div class="item-info">
              <h3>{{ trans.title if trans else 'No Company' }}</h3>
              <p>{{ trans.subtitle if trans else 'No Role' }} • {{ e.start_date or '' }} - {{ e.end_date or 'Present' }}
              </p>
            </div>
            <div class="item-actions">
              <button class="action-btn delete"
                onclick="event.stopPropagation(); deleteItem('experience', {{ e.id }})"><i
                  class="fas fa-trash"></i></button>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Education Sub-View -->
      <div id="resume-education" class="resume-tab-content hidden">
        <div class="header" style="margin-bottom: 1rem;">
          <h3>Education History</h3>
          <button class="btn btn-primary" onclick="openModal('education')"><i class="fas fa-plus"></i> Add</button>
        </div>
        <div class="item-list">
          {% for e in education %}
          {% set trans = e.translations | selectattr('lang', 'equalto', 'es') | first %}
          <div class="list-item" onclick='editEducation({{ e.id }})' style="cursor: pointer;">
            <div class="item-info">
              <h3>{{ e.institution }}</h3>
              <p>{{ trans.title if trans else '' }} • {{ e.start_date or '' }} - {{ e.end_date or 'Present' }}</p>
            </div>
            <div class="item-actions">
              <button class="action-btn delete"
                onclick="event.stopPropagation(); deleteItem('education', {{ e.id }})"><i
                  class="fas fa-trash"></i></button>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Certifications Sub-View -->
      <div id="resume-certifications" class="resume-tab-content hidden">
        <div class="header" style="margin-bottom: 1rem;">
          <h3>Certifications</h3>
          <button class="btn btn-primary" onclick="openModal('certification')"><i class="fas fa-plus"></i> Add</button>
        </div>
        <div class="item-list">
          {% for c in certifications %}
          {% set trans = c.translations | selectattr('lang', 'equalto', 'es') | first %}
          <div class="list-item" onclick='editCertification({{ c.id }})' style="cursor: pointer;">
            <div class="item-info">
              <h3>{{ trans.title if trans else c.slug }}</h3>
              <p>{{ c.issuer or '' }} • {{ c.issue_date or '' }}</p>
            </div>
            <div class="item-actions">
              <button class="action-btn delete"
                onclick="event.stopPropagation(); deleteItem('certification', {{ c.id }})"><i
                  class="fas fa-trash"></i></button>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Skills View -->
    <div id="view-skills" class="view-section hidden">
      <div class="header">
        <h2>Skills</h2>
        <button class="btn btn-primary" onclick="openModal('skill')"><i class="fas fa-plus"></i> Add Skill</button>
      </div>
      <div class="item-list">
        {% for category, items in skills|groupby('category') %}
        <details class="category-group">
          <summary
            style="margin: 1.5rem 0 0.5rem; color: var(--accent); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; outline: none; user-select: none;">
            {{ category or 'Uncategorized' }} <span style="font-size: 0.8em; opacity: 0.7; margin-left: 0.5rem;">({{
              items|length }})</span>
          </summary>
          <div class="list-group">
            {% for s in items %}
            {% set trans = s.translations | selectattr('lang', 'equalto', 'es') | first %}
            <div class="list-item" onclick='editSkill({{ s.id }})' style="cursor: pointer;">
              <div class="item-info">
                <h3>{{ trans.name if trans else s.slug }}</h3>
                <p>{{ s.proficiency }}%</p>
              </div>
              <div class="item-actions">
                <button class="action-btn delete" onclick="event.stopPropagation(); deleteItem('skill', {{ s.id }})"><i
                    class="fas fa-trash"></i></button>
              </div>
            </div>
            {% endfor %}
          </div>
        </details>
        {% endfor %}
      </div>
    </div>

    <!-- Profile View -->
    <div id="view-profile" class="view-section hidden">
      <div class="header">
        <h2>Profile</h2>
        <button class="btn btn-primary" onclick="saveProfile()"><i class="fas fa-save"></i> Save Changes</button>
      </div>
      <div class="card" style="background: var(--bg-card); padding: 2rem; border-radius: 0.5rem;">
        <form id="profile-form">
          <div class="form-group">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" name="name" value="{{ profile.name }}">
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email" value="{{ profile.email }}">
          </div>
          <div class="form-group">
            <label class="form-label">Location (JSON)</label>
            <input type="text" class="form-control" name="location" value='{{ profile.location | tojson }}'>
          </div>
          <div class="form-group">
            <label class="form-label">Social Links (JSON)</label>
            <input type="text" class="form-control" name="social" value='{{ profile.social_links | tojson }}'>
          </div>

          <div class="tabs">
            <div class="tab active" onclick="switchTab(this, 'profile-es')">Spanish</div>
            <div class="tab" onclick="switchTab(this, 'profile-en')">English</div>
          </div>

          {% set trans_es = profile.translations | selectattr('lang', 'equalto', 'es') | first %}
          {% set trans_en = profile.translations | selectattr('lang', 'equalto', 'en') | first %}

          <div id="profile-es" class="tab-content">
            <div class="form-group">
              <label class="form-label">Role (ES)</label>
              <input type="text" class="form-control" name="role_es" value="{{ trans_es.role if trans_es else '' }}">
            </div>
            <div class="form-group">
              <label class="form-label">Tagline (ES)</label>
              <input type="text" class="form-control" name="tagline_es"
                value="{{ trans_es.tagline if trans_es else '' }}">
            </div>
            <div class="form-group">
              <label class="form-label">Bio (ES)</label>
              <textarea class="form-control" name="bio_es">{{ trans_es.bio if trans_es else '' }}</textarea>
            </div>
          </div>

          <div id="profile-en" class="tab-content hidden">
            <div class="form-group">
              <label class="form-label">Role (EN)</label>
              <input type="text" class="form-control" name="role_en" value="{{ trans_en.role if trans_en else '' }}">
            </div>
            <div class="form-group">
              <label class="form-label">Tagline (EN)</label>
              <input type="text" class="form-control" name="tagline_en"
                value="{{ trans_en.tagline if trans_en else '' }}">
            </div>
            <div class="form-group">
              <label class="form-label">Bio (EN)</label>
              <textarea class="form-control" name="bio_en">{{ trans_en.bio if trans_en else '' }}</textarea>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Generic Modal -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Edit Item</h3>
        <button class="action-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" id="modal-form-container">
        <!-- Form injected via JS -->
      </div>
      <div class="modal-header"
        style="border-top: 1px solid var(--border); border-bottom: none; justify-content: flex-end; gap: 1rem;">
        <button class="btn" style="background: var(--border)" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveItem()">Save</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">Action successful</div>

  <!-- Initialize data from server -->
  <script>
    window.projects = {{ projects | tojson }};
    window.experiences = {{ experiences | tojson }};
    window.education = {{ education | tojson }};
    window.skills = {{ skills | tojson }};
    window.certifications = {{ certifications | tojson }};
  </script>

  <script src="{{ url_for('static', filename='scripts/admin.js') }}"></script>
</body>

</html>